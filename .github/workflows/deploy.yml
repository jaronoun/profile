name: Deploy profile

on:
  push:
    branches: [ main ]
    paths:
      - 'profile/**'

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT || 22 }}
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # Navigate to project directory
          cd /home/brouwnie/Documents/Github/profile
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main
          
          # Navigate to jyo-index directory
          cd jyo-index
          
          # Stop existing container
          echo "ğŸ›‘ Stopping existing container..."
          docker-compose down || docker compose down
          
          # Remove old images to free up space
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f
          
          # Rebuild and start container
          echo "ğŸ”¨ Building and starting new container..."
          docker-compose up -d --build --force-recreate || docker compose up -d --build --force-recreate
          
          # Wait for container to be ready
          echo "â³ Waiting for container to start..."
          sleep 15
          
          # Verify deployment
          echo "ğŸ” Verifying deployment..."
          if curl -f http://localhost:3069/; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
            exit 1
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
